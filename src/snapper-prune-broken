#!/bin/bash
# systemd-boot-snapper-tools: snapper-prune-broken

if [[ $EUID -ne 0 ]]; then
   echo "This script must be run as root"
   exit 1
fi

# 1. Mount Btrfs root to see everything
mkdir -p /tmp/btrfs_admin
mount $(findmnt -no SOURCE /) -o subvolid=5 /tmp/btrfs_admin
cd /tmp/btrfs_admin || exit

echo "--- Searching for broken/archived subvolumes ---"

# 2. Cleanup nested subvolumes in deleted snapshots
# Snapper sometimes leaves the directory structure if the subvolume delete fails
for snap_dir in @snapshots/*; do
    if [[ -d "$snap_dir" && ! -f "$snap_dir/info.xml" ]]; then
        echo "Found orphaned snapshot directory: $snap_dir (Deleting nested contents...)"
        # Use btrfs sub delete recursively for any hidden sub-layers
        find "$snap_dir" -type d -exec btrfs subvolume delete {} + 2>/dev/null
        rm -rf "$snap_dir"
    fi
done

# 3. Cleanup archived rollbacks older than X days
# Defaulting to 7 days to be safe
KEEP_DAYS=7
echo "Cleaning up rollback backups older than $KEEP_DAYS days..."
find . -maxdepth 1 -name "@_backup_*" -type d -mtime +$KEEP_DAYS | while read -r backup; do
    echo "Pruning old backup: $backup"
    btrfs subvolume delete "$backup" || rm -rf "$backup"
done

# 4. Clean up
cd /
umount /tmp/btrfs_admin
rmdir /tmp/btrfs_admin

echo "--- Pruning Complete ---"
